<html>

<input type="file" id="files" name="files[]" multiple style="width:500px;"/>
<div id="sampleTime"></div>
<div id="runTime"></div>

<div class="tabs">
  <ul class="tab-links">
      <li class="active"><a href="#bottomUp">Bottom Up</a></li>
      <li><a href="#topDown">Top Down</a></li>
  </ul>

  <div class="tab-content">
    <div id="bottomUp" class="tab active">
      <table id="bottomUpPerfTable" class="perfTable">
        <tr>
          <th>Function Name</th>
          <th>Self Time In Function(us)</th>
          <th>Total Time In Function(us)</th>
          <th>Number of Sampled Calls</th>
          <th>Hot Lines(line, samples)</th>
        </tr>
      </table>
    </div>
    <div id="topDown" class="tab">
      <table id="topDownPerfTable" class="perfTable">
        <tr>
          <th>Function Name</th>
          <th>Self Time In Function(us)</th>
          <th>Total Time In Function(us)</th>
          <th>Number of Sampled Calls</th>
          <th>Hot Lines(line, samples)</th>
        </tr>
      </table>
    </div>
  </div>
</div>

<style type="text/css">

  .tabs {
    width:100%;
    display:inline-block;
  }
 
  /*----- Tab Links -----*/
  /* Clearfix */
  .tab-links:after {
    display:block;
    clear:both;
    content:'';
  }
 
  .tab-links li {
    margin:0px 5px;
    float:left;
    list-style:none;
  }

  .tab-links a {
    padding:9px 15px;
    display:inline-block;
    border-radius:3px 3px 0px 0px;
    background:#7FB5DA;
    font-size:16px;
    font-weight:600;
    color:#4c4c4c;
    transition:all linear 0.15s;
  }
 
  .tab-links a:hover {
    background:#a7cce5;
    text-decoration:none;
  }
 
  li.active a, li.active a:hover {
    background:#fff;
    color:#4c4c4c;
  }
 
  /*----- Content of Tabs -----*/
  .tab-content {
    padding:15px;
    border-radius:3px;
    box-shadow:-1px 1px 1px rgba(0,0,0,0.15);
    background:#fff;
  }
 
  .tab {
    display:none;
  }
 
  .tab.active {
    display:block;
  }

  table.perfTable tr:nth-child(even) {
      background-color: #eee;
  }
  table.perfTable tr:nth-child(odd) {
      background-color: #fff;
  }
</style>

<script src="./jquery-2.1.3.min.js"></script>

<script>

  var perfData = {};
  var buTableRoot = document.getElementById('bottomUpPerfTable');
  var tdTableRoot = document.getElementById('topDownPerfTable');

  function sortFuncForTable(tableNode) {
    if (tableNode == buTableRoot) {
      return function(d1, d2) { return d2.d.st - d1.d.st; };
    }
    return function(d1, d2) { return d2.d.tt - d1.d.tt; };
  }

  function getFunctionData(fnName) {
    fnName = fnName.trim();
    var d = perfData[fnName];
    return {
      fnName : fnName,
      tt : d.tt,
      st : d.st,
      callers: d.clrs,
      lines: d.lns,
      n : d.n
    };
  }

  function expandFnRow(table, row) {
    var curRowDepth = parseInt(row.getAttribute('depth'), 10);
    row.setAttribute('expanded', true);
    var fnName = row.children[0].innerText;
    var callers = getFunctionData(fnName).callers;
    var next = row.nextSibling;

    displayFnData(callers, table, next, curRowDepth + 1, sortFuncForTable(table));
  }

  function collapseFnRow(table, row) {
    var curRowDepth = parseInt(row.getAttribute('depth'), 10);
    row.removeAttribute('expanded');
    var done = false;

    while (!done) {
      done = true;
      var sib = row.nextSibling;
      if (sib) {
        var sibDepth = parseInt(sib.getAttribute('depth'), 10);
        if (sibDepth > curRowDepth) {
          done = false;
          table.removeChild(sib);
        }
      }
    }    
  }

  function rowClickHandler(e) {
    var row = e.currentTarget;
    var rowTableParent = row.parentElement;
    var isExpanded = row.hasAttribute('expanded');

    if (!isExpanded) {
      expandFnRow(rowTableParent, row);
    } else {
      collapseFnRow(rowTableParent, row);
    }
  }

  function makeDepthSpaces(depth) {
    var result = '';
    for (var i = 0; i < depth * 4; i++) {
      result = result + '&nbsp;';
    }
    return result;
  }

  function formatHotLines(lines) {
    lines.sort(function(l1, l2) {
      return l2.t - l1.t;
    });

    var result = '';
    for (var i = 0; i < lines.length; i++) {
      result += '(' + lines[i]['#'] + ', ' + lines[i].t + ') ';
    }
    return result;
  }

  function makeFuncRow(fnData, callCount, depth) {
    var rowNode = document.createElement('tr');
    rowNode.setAttribute('depth', depth);
    var depthSpaces = makeDepthSpaces(depth);
    var rd;
    
    rd = document.createElement('td');
    rd.innerText = fnData.fnName;
    rd.innerHTML = depthSpaces + rd.innerText;
    rowNode.appendChild(rd);

    rd = document.createElement('td');
    rd.innerText = fnData.st;
    rowNode.appendChild(rd);

    rd = document.createElement('td');
    rd.innerText = fnData.tt;
    rowNode.appendChild(rd);

    rd = document.createElement('td');
    rd.innerText = callCount;
    rowNode.appendChild(rd);

    rd = document.createElement('td');
    rd.innerText = formatHotLines(fnData.lines);
    rowNode.appendChild(rd);

    rowNode.onclick = rowClickHandler;

    return rowNode;
  }

  function addFuncData(fnData, callCount, parentNode, nextNode, depth) {
    parentNode.insertBefore(makeFuncRow(fnData, callCount, depth), nextNode);
  }

  /*function openFunction(fName, parentNode) {
    var fnData = getFunctionData(fName);

    for (var i = 0; i < fnData.clrs.length; i++) {
      addFuncData(fnData.clrs[i], parentNode);
    }
  }*/

  function displayFnData(fns, parent, lastElement, depth, sortFunc) {
    var data = [];
    for (var i = 0; i < fns.length; i++) {
      data.push({d: getFunctionData(fns[i].nm), n: fns[i].n});
    }

    data.sort(sortFunc);

    for (var i = 0; i < data.length; i++) {
      addFuncData(data[i].d, data[i].n, parent, lastElement, depth);
    }
  }

  function displayRoot(rootNode, sortFunc) {
    while (rootNode.children.length > 1) {
      rootNode.removeChild(rootNode.lastChild);
    }
    var fns = [];
    for (var key in perfData) {
      if (perfData.hasOwnProperty(key)) {
        fns.push({ nm: key, n: getFunctionData(key).n });
      }
    }

    displayFnData(fns, rootNode, null, 0, sortFunc);
  }

  function handleFileSelect(evt) {
    var files = evt.target.files; // FileList object
    var file = files[0];

    var reader = new FileReader();

    // Closure to capture the file information.
    reader.onload = function(e) {
        var allData = JSON.parse(e.target.result);
        perfData = allData.profile_data;
        metaData = allData.metadata;
        document.getElementById('sampleTime').innerText = metaData.profiling_time + " ms of samples taken";
        document.getElementById('runTime').innerText = metaData.run_time + " ms wall-clock time";
        displayRoot(buTableRoot, sortFuncForTable(buTableRoot));
        displayRoot(tdTableRoot, sortFuncForTable(tdTableRoot));
    };
    reader.readAsText(file);
  }

  function main() {
    $(document).ready(function() {
      $('.tabs .tab-links a').on('click', function(e)  {
          var currentAttrValue = $(this).attr('href');
   
          // Show/Hide Tabs
          $('.tabs ' + currentAttrValue).show().siblings().hide();
   
          // Change/remove current tab to active
          $(this).parent('li').addClass('active').siblings().removeClass('active');
   
          e.preventDefault();
      });
    });
    document.getElementById('files').addEventListener('change', handleFileSelect, false);    
  }

  main();
</script>

</html>
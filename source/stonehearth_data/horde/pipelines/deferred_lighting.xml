<Pipeline>
  <Setup>
    <RenderTarget id="AttributeBuffer" depthBuf="true" numColBufs="2" format="RGBA32F" scale="1.0"/>
    <RenderTarget id="LightingBuffer" depthBuf="false" numColBufs="1" format="RGBA32F" scale="1.0"/>
    <RenderTarget id="OUTPUT" depthBuf="true" numColBufs="1" format="RGBA8" maxSamples="4" scale="1.0" />
    <RenderTarget id="SSAOBUF" depthBuf="false" numColBufs="1" format="RGBA8" maxSamples="4" scale="1.0" />
    <RenderTarget id="SSAOBLUR" depthBuf="false" numColBufs="1" format="RGBA8" maxSamples="4" scale="1.0" />
    <RenderTarget id="TEMPSSAOBLUR" depthBuf="false" numColBufs="1" format="RGBA8" scale="1.0" />
    <RenderTarget id="SelectedTemp" depthBuf="true" numColBufs="1" format="RGBA8" scale="1.0"/>
  </Setup>
  <CommandQueue>

    <Stage id="Setup">
      <SwitchTarget target="OUTPUT" />
      <ClearTarget colBuf0="true" depthBuf="true"/>
    </Stage>

    <Stage id="AttributePass">
      <SwitchTarget target="AttributeBuffer" />
      <ClearTarget depthBuf="true" />
      <DrawGeometry context="DEPTH_AND_LIGHT_ATTRIBUTES" class="~Translucent" />
    </Stage>

    <Stage id="Lighting">
      <SwitchTarget target="LightingBuffer" />
      <ClearTarget colBuf0="true" />
      <BindBuffer sampler="normals" sourceRT="AttributeBuffer" bufIndex="0" />
      <BindBuffer sampler="positions" sourceRT="AttributeBuffer" bufIndex="1" />
      <BindBuffer sampler="depth" sourceRT="AttributeBuffer" bufIndex="32" />

      <DoDeferredLightLoop class="~Translucent" noShadows="false"/>

      <UnbindBuffers />
    </Stage>

    <!-- This stage should only be enabled when SSAO is disabled. -->
    <Stage id="SSAO Default" enabled="false">
      <SwitchTarget target="SSAOBUF"/>
      <ClearTarget colBuf0="true" col_R="1.0" col_G="1.0" col_B="1.0" col_A="1.0"/>
      <SwitchTarget target="SSAOBLUR"/>
      <ClearTarget colBuf0="true" col_R="1.0" col_G="1.0" col_B="1.0" col_A="1.0"/>
    </Stage>

    <Stage id="SSAO">
      <SwitchTarget target="SSAOBUF" />
      <BindBuffer sampler="normals" sourceRT="AttributeBuffer" bufIndex="0" />
      <BindBuffer sampler="depth" sourceRT="AttributeBuffer" bufIndex="32" />
      <BindBuffer sampler="positions" sourceRT="AttributeBuffer" bufIndex="1" />

      <DrawQuad material="materials/ssao.material.xml" context="SSAO2"/>
      <UnbindBuffers />
    </Stage>

    <!--Stage id="Depth-sensitive SSAO Blur" >
      <SwitchTarget target="TEMPSSAOBLUR" />
      <BindBuffer sampler="depth" sourceRT="AttributeBuffer" bufIndex="32" />
      <BindBuffer sampler="ssao" sourceRT="SSAOBUF" bufIndex="0" />
      <DrawQuad material="materials/ssao.material.xml" context="BLUR_X" />
      <UnbindBuffers />

      <SwitchTarget target="SSAOBLUR" />
      <BindBuffer sampler="depth" sourceRT="AttributeBuffer" bufIndex="32" />
      <BindBuffer sampler="ssao" sourceRT="TEMPSSAOBLUR" bufIndex="0" />
      <DrawQuad material="materials/ssao.material.xml" context="BLUR_Y" />
      <UnbindBuffers />
    </Stage-->

    <Stage id="Simple, once-pass SSAO Blur" >
      <SwitchTarget target="SSAOBLUR" />
      <BindBuffer sampler="ssao" sourceRT="SSAOBUF" bufIndex="0" />
      <DrawQuad material="materials/ssao.material.xml" context="BLUR" />
      <UnbindBuffers />
    </Stage>

    <!-- This stage should only be enabled when SSAO blurring is disabled, but SSAO
         is enabled -->
    <Stage id="SSAO Copy" enabled="false">
      <SwitchTarget target="SSAOBLUR" />
      <BindBuffer sampler="buf0" sourceRT="SSAOBUF" bufIndex="0" />
      <DrawQuad material="pipelines/outline.material.xml" context="DRAW_COLORBUF" />
      <UnbindBuffers />
    </Stage>

    <Stage id="Material">
      <SwitchTarget target="OUTPUT" />
      <BindBuffer sampler="lightingBuffer" sourceRT="LightingBuffer" bufIndex="0"/>
      <BindBuffer sampler="ssaoBuffer" sourceRT="SSAOBLUR" bufIndex="0"/>

      <DrawGeometry context="MATERIAL" class="~Translucent" />

      <UnbindBuffers />
    </Stage>

    <Stage id="Translucent">
      <SwitchTarget target="OUTPUT" />
      <DrawGeometry context="TRANSLUCENT"/>
      <DrawGeometry context="BLUEPRINTS" />
      <DrawGeometry context="DEBUG_SHAPES" />
    </Stage>

    <Stage id="Clouds">
      <SwitchTarget target="OUTPUT" />
      <DrawGeometry context="CLOUDS" class="~Translucent" />
    </Stage>

    <Stage id="Selected">
       <SwitchTarget target="SelectedTemp" />
       <ClearTarget colBuf0="true" depthBuf="true"/>
       <DrawSelected context="SELECTED_SCREENSPACE" />

       <SwitchTarget target="OUTPUT" />
       <BindBuffer sampler="outlineSampler" sourceRT="SelectedTemp" bufIndex="0"/>
       <BindBuffer sampler="outlineDepth" sourceRT="SelectedTemp" bufIndex="32"/>
       <DrawQuad material="terrain/default_material.xml" context="SELECTED_SCREENSPACE_OUTLINER" />
       <UnbindBuffers />
    </Stage>

    <Stage id="Final">
       <SwitchTarget target="" />
       <BindBuffer sampler="buf0" sourceRT="OUTPUT" bufIndex="0" />
       <DrawQuad material="pipelines/outline.material.xml" context="DRAW_COLORBUF" />
       <UnbindBuffers />
    </Stage>

    <Stage id="Overlays">
      <DrawOverlays context="OVERLAY" />
    </Stage>









  </CommandQueue>
</Pipeline>
<Pipeline>
  <Setup>
    <RenderTarget id="GBUFFER" depthBuf="true" numColBufs="4" format="RGBA16F" scale="1.0"/>
    <RenderTarget id="MBUFF" depthBuf="true" numColBufs="1" format="RGBA16F" scale="1.0"/>
    <RenderTarget id="BLURBUF1" depthBuf="false" numColBufs="1" format="RGBA8" scale="0.5"/>
    <RenderTarget id="BLURBUF2" depthBuf="false" numColBufs="1" format="RGBA8" scale="0.5"/>
    <RenderTarget id="FINALIMAGE" depthBuf="false" numColBufs="1" format="RGBA16F" scale="1.0"/>
    <RenderTarget id="OUTLINE" depthBuf="false" numColBufs="1" format="RGBA8" scale="1.0"/>
    <RenderTarget id="SSAOBUF" depthBuf="false" numColBufs="1" format="RGBA8" scale="1.0" />
    <RenderTarget id="SSAOBLUR" depthBuf="false" numColBufs="1" format="RGBA8" scale="1.0" />
    <RenderTarget id="TEMPSSAOBLUR" depthBuf="false" numColBufs="1" format="RGBA8" scale="1.0" />
  </Setup>
  <CommandQueue>
    <Stage id="Attribpass">
      <SwitchTarget target="GBUFFER" />
      <ClearTarget depthBuf="true" colBuf0="true" />
      <DrawGeometry context="ATTRIBPASS" class="~Translucent"/>
    </Stage>
    <Stage id="Lighting" link="pipelines/globalSettings.material.xml">
      <SwitchTarget target="MBUFF" />

      <!-- Copy depth buffer to allow occlusion culling of lights
              For some reason, we need to clear the depth buffer of the MBUFF before copying
              the contents of the GBUFFER depth texture.  Setting ZEnable to false in the
              COPY_DEPTH lighting material doesn't help.  Ideally, we would just clober the
              MBUFF depth buffer unconditionally. -->

      <ClearTarget depthBuf="true"/>
      <BindBuffer sampler="depthBuf" sourceRT="GBUFFER" bufIndex="32" />
      <DrawQuad material="materials/light.material.xml" context="COPY_DEPTH" />
      <UnbindBuffers />

      <BindBuffer sampler="gbuf0" sourceRT="GBUFFER" bufIndex="0" />
      <BindBuffer sampler="gbuf1" sourceRT="GBUFFER" bufIndex="1" />
      <BindBuffer sampler="gbuf2" sourceRT="GBUFFER" bufIndex="2" />
      <BindBuffer sampler="gbuf3" sourceRT="GBUFFER" bufIndex="3" />

      <DrawQuad material="materials/light.material.xml" context="AMBIENT" />

      <DoDeferredLightLoop class="~Translucent"/>

      <UnbindBuffers />
    </Stage>
    <!--Stage id="Translucent">
      <SwitchTarget target="MBUFF" />
      <DrawGeometry context="TRANSLUCENT"/>
      <DrawGeometry context="DEBUG_SHAPES" />
    </Stage-->
    <!--Stage id="Selected">
      <DrawSelected context="SELECTED" />
    </Stage-->
    
    <Stage id="SSAO">
      <SwitchTarget target="SSAOBUF" />
      <BindBuffer sampler="depthbuff" sourceRT="GBUFFER" bufIndex="32" />
      <DrawQuad material="materials/ssao.material.xml" context="SSAO"/>
      <UnbindBuffers />
    </Stage>

    <Stage id="SSAO Blur" >
      <SwitchTarget target="TEMPSSAOBLUR" />
      <BindBuffer sampler="depthbuff" sourceRT="GBUFFER" bufIndex="32" />
      <BindBuffer sampler="ssaobuff" sourceRT="SSAOBUF" bufIndex="0" />
      <DrawQuad material="materials/ssao.material.xml" context="BLUR_X" />
      <UnbindBuffers />

      <SwitchTarget target="SSAOBLUR" />
      <BindBuffer sampler="depthbuff" sourceRT="GBUFFER" bufIndex="32" />
      <BindBuffer sampler="ssaobuff" sourceRT="TEMPSSAOBLUR" bufIndex="0" />
      <DrawQuad material="materials/ssao.material.xml" context="BLUR_Y" />
      <UnbindBuffers />

    </Stage>

    <Stage id="Combination">
      <SwitchTarget target="FINALIMAGE" />
      <ClearTarget colBuf0="true" />

      <BindBuffer sampler="depthBuf" sourceRT="GBUFFER" bufIndex="32" />
      <BindBuffer sampler="buf0" sourceRT="MBUFF" bufIndex="0" />
      <BindBuffer sampler="buf1" sourceRT="BLURBUF1" bufIndex="0" />
      <BindBuffer sampler="buf2" sourceRT="OUTLINE" bufIndex="0" />
      <BindBuffer sampler="buf3" sourceRT="SSAOBLUR" bufIndex="0" />
      <DrawQuad material="pipelines/outline.material.xml" context="FINALPASS" />
      <UnbindBuffers />
    </Stage>
    <Stage id="FXAA">
      <SwitchTarget target=""/>
      <BindBuffer sampler="buf0" sourceRT="FINALIMAGE" bufIndex="0" />
      <DrawQuad material="pipelines/outline.material.xml" context="FXAA" />
      <UnbindBuffers />
    </Stage>
    <Stage id="Overlays">
      <DrawOverlays context="OVERLAY" />
    </Stage>
  </CommandQueue>
</Pipeline>
<!-- Forward Shading Pipeline -->
<Pipeline name="FORWARD_POSTPROCESS">
   <Setup>
      <RenderTarget id="GBuffers" numColBufs="2" depthBuf="true" format="RGBA32F" scale="1.0" mipLevels="5"/>
      <RenderTarget id="SSAOTemp" numColBufs="1" depthBuf="false" format="RGBA8" scale="1.0" />
      <RenderTarget id="SSAOBlur" numColBufs="1" depthBuf="false" format="RGBA8" scale="1.0" />
      <RenderTarget id="SelectedTemp" numColBufs="1" depthBuf="true" scale="1.0" format="RGBA8"/>
      <RenderTarget id="SkyTemp" numColBufs="1" depthBuf="false" scale="0.125" format="RGBA8"/>
   </Setup>
   <CommandQueue>
      <Stage id="Init">
         <SwitchTarget target="GBuffers" />
         <ClearTarget colBuf0="true" colBuf1="true" depthBuf="true" />

         <SwitchTarget target="" />
         <ClearTarget colBuf0="true" depthBuf="true" />
      </Stage>

      <Stage id="Sky">
         <DrawGeometry context="SKY" />

         <SwitchTarget target="SkyTemp" />
         <DrawGeometry context="SKY" />
      </Stage>

      <Stage id="Starfield">
         <DrawGeometry context="STARFIELD" />
      </Stage>

      <Stage id="Depth">
         <SwitchTarget target="GBuffers" />
         <DrawGeometry context="DEPTH_LINEAR" class="~Translucent" />

         <ClearTarget colBuf0="false" colBuf1="false" depthBuf="true" />
         <DrawGeometry context="DEPTH_LINEAR_BACK" class="~Translucent" />

         <SwitchTarget target="" />
         <DrawGeometry context="DEPTH" class="~Translucent" />
      </Stage>

      <Stage id="SSAO">
         <BuildMipmaps rt="GBuffers" index="0" />

         <SwitchTarget target="SSAOTemp" />
         <BindBuffer sampler="depthBuffer" sourceRT="GBuffers" bufIndex="0" />
         <BindBuffer sampler="normalBuffer" sourceRT="GBuffers" bufIndex="1" />
         <DrawQuad material="materials/ssao.material.xml" context="SSAO" />
         <UnbindBuffers />

         <SwitchTarget target="SSAOBlur"/>
         <BindBuffer sampler="depthBuffer" sourceRT="GBuffers" bufIndex="0" />
         <BindBuffer sampler="ssaoImage" sourceRT="SSAOTemp" bufIndex="0" />
         <DrawQuad material="materials/blur.material.xml" context="BLUR" />
         <UnbindBuffers />

         <SwitchTarget target=""/>
      </Stage>

      <Stage id="Light">
         <BindBuffer sampler="ssaoImage" sourceRT="SSAOBlur" bufIndex="0" />
         <DoForwardLightLoop class="~Translucent" noShadows="false"/>
         <UnbindBuffers />
      </Stage>


      <Stage id="Fog">
         <BindBuffer sampler="skySampler" sourceRT="SkyTemp" bufIndex="0"/>
         <DrawGeometry class="~Translucent" context="FOG" noShadows="true" frustum_start="0.7"/>
         <UnbindBuffers />
      </Stage>

      <Stage id="Translucent">
         <DrawGeometry context="TRANSLUCENT_ON_TOP" order="BACK_TO_FRONT" />
         <DrawGeometry context="TRANSLUCENT" order="BACK_TO_FRONT" />
         <DrawGeometry context="BLUEPRINTS_DEPTH_PASS"/>
         <DrawGeometry context="BLUEPRINTS_COLOR_PASS"/>
         <DrawGeometry context="DEBUG_SHAPES" />
      </Stage>

      <Stage id="Selected">
         <SwitchTarget target="SelectedTemp" />
         <ClearTarget colBuf0="true" depthBuf="true"/>
         <DrawSelected context="SELECTED_SCREENSPACE" />

         <SwitchTarget target="" />
         <BindBuffer sampler="outlineSampler" sourceRT="SelectedTemp" bufIndex="0"/>
         <BindBuffer sampler="outlineDepth" sourceRT="SelectedTemp" bufIndex="32"/>
         <DrawQuad material="materials/base.material.xml" context="SELECTED_SCREENSPACE_OUTLINER" />
         <UnbindBuffers />
      </Stage>

      <Stage id="Selected_Fast">
         <DrawSelected context="SELECTED_FAST" />
      </Stage>

      <Stage id="Overlays">
         <DrawOverlays context="OVERLAY"/>
      </Stage>
   </CommandQueue>
</Pipeline>